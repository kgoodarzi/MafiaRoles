<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Game - Night Phase</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dark-theme.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase initialization -->
    <script src="supabase-init.js"></script>
    <!-- Database Manager -->
    <script src="database.js"></script>
    <!-- Roles JS -->
    <script src="roles.js"></script>
    <!-- Connection Status -->
    <script src="connection-status.js"></script>
    <!-- Configuration Settings -->
    <script src="config.js"></script>
    <style>
        /* Timer specific styles */
        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            transition: color 0.3s ease;
        }
        
        .timer-progress {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 1s linear;
        }
        
        .timer-warning .timer-bar {
            background-color: var(--warning-color, #ff9800);
        }
        
        .timer-danger .timer-bar {
            background-color: var(--mafia-color, #e53935);
        }
        
        .night-call-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .role-call {
            margin-bottom: 15px;
        }
        
        
        .active-role-card {
            width: 180px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .active-role-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .active-role-card.blocked {
            border: 2px solid var(--warning-color, #ff9800);
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        /* Ocean players grid - Two column layout */
        #ocean-players {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .player-card {
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }
        
        .player-card.selected {
            border: 3px solid var(--primary-color);
            background-color: rgba(0, 123, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .player-card.selected::after {
            content: "âœ“";
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Active player (role holder) styling */
        .player-card.active-player {
            border: 2px solid var(--success-color, #28a745);
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        /* Team member styling */
        .player-card.team-player {
            border: 2px solid var(--info-color, #17a2b8);
            background-color: rgba(23, 162, 184, 0.1);
        }
        
        /* Restore the player card styling */
        .player-card.disabled {
            opacity: 1;
            cursor: pointer;
            pointer-events: auto;
            filter: none;
        }
        
        /* Add styles for disabled player images only */
        .player-image.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(70%);
            pointer-events: none;
        }
        
        .player-image {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .player-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-info {
            padding: 10px 5px;
            text-align: center;
        }
        
        .position-relative {
            position: relative;
        }
        
        .code-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .code-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
        }
        
        .code-btn.selected {
            background-color: var(--success-color, #4caf50);
            transform: scale(1.1);
        }
        
        .action-result {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--card-bg-darker, #222);
            border-radius: 8px;
            text-align: center;
        }
        
        .action-result.success {
            border-left: 4px solid var(--success-color, #4caf50);
        }
        
        .action-result.warning {
            border-left: 4px solid var(--warning-color, #ff9800);
        }
        
        .action-result.danger {
            border-left: 4px solid var(--mafia-color, #e53935);
        }
        
        .night-result {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .night-result-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--card-bg-darker, #222);
        }
        
        /* Button disabled styles */
        button:disabled,
        .btn:disabled,
        .code-btn:disabled {
            background-color: #666666 !important;
            color: #999999 !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
            transform: none !important;
            box-shadow: none !important;
            pointer-events: none !important;
            border-color: #666666 !important;
        }
        
        .btn.btn-done {
            background-color: var(--success-color, #4caf50);
            color: white;
        }
        
        /* Roles display */
        .roles-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .role-card {
            width: 150px;
            margin: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        
        .role-card.mafia {
            border: 2px solid var(--mafia-color, #e53935);
        }
        
        .role-card.citizen {
            border: 2px solid var(--primary-color);
        }
        
        .role-card.independent {
            border: 2px solid var(--warning-color, #ff9800);
        }
        
        .role-card img {
            width: 100%;
            height: 125px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .role-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .player-name {
            color: #aaa;
        }
        
        /* Badges */
        .role-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .mafia .role-badge {
            background-color: var(--mafia-color, #e53935);
        }
        
        .citizen .role-badge {
            background-color: var(--primary-color);
        }
        
        .independent .role-badge {
            background-color: var(--warning-color, #ff9800);
        }
        
        .eliminated-player {
            position: relative;
            filter: grayscale(80%);
            opacity: 0.7;
        }
        
        .eliminated-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(135deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 49%, rgba(255,0,0,0.7) 49%, rgba(255,0,0,0.7) 51%, rgba(0,0,0,0) 51%, rgba(0,0,0,0) 100%);
            background-size: 10px 10px;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            .roles-container {
                justify-content: space-around;
            }
            
            .role-card {
                width: 120px;
                margin: 5px;
            }
            
            .role-card img {
                height: 100px;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Additional detective result styling */
        .detective-result-icon {
            font-size: 3rem;
            margin-right: 10px;
        }
        
        .detective-result-mafia {
            color: var(--mafia-color, #e53935);
        }
        
        .detective-result-innocent {
            color: var(--success-color, #4caf50);
        }
        
        /* Gunman ammo selection */
        .ammo-selection {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 20px;
        }
        
        .ammo-option {
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            transition: all 0.2s ease;
            width: 120px;
            background-color: var(--card-bg);
        }
        
        .ammo-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .ammo-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .ammo-option img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        .ammo-name {
            font-weight: bold;
        }
        
        /* Timer specific styles */
        .timer {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="dark-theme">
    <div id="connection-status"></div>
    
    <div class="container">
        <header>
            <h1>Night Phase</h1>
            <p id="night-phase-subtitle">Night Phase - Round 1</p>
        </header>

        <main>
            <section id="night-phase-section">
                <div id="phase-info" class="phase-info">
                    <h2>Night Phase</h2>
                    <p>The Moderator calls each role in sequence to perform their night actions.</p>
                </div>

                <!-- Night Call Sequence -->
                <div id="night-sequence-container">
                    <!-- 1. Mafia Call -->
                    <div id="mafia-call" class="night-call-section">
                        <h3>1. Mafia Team Wake Up</h3>
                        <p>Call all Mafia members to wake up and perform their actions.</p>
                        
                        <!-- Godfather Action -->
                        <div id="godfather-action" class="role-call">
                            <h4>Godfather's Action</h4>
                            <div class="action-description">Select a player to eliminate from the game.</div>
                            <div id="godfather-players" class="players-grid">
                            </div>
                            <div id="godfather-result" class="action-result" style="display:none;"></div>
                        </div>
                        
                        <!-- Magician Action -->
                        <div id="magician-action" class="role-call">
                            <h4>Magician's Action</h4>
                            <p>Choose a player to be blocked:</p>
                            <div id="magician-players" class="players-grid">
                                <!-- Player cards will be dynamically added here -->
                            </div>
                            <div id="magician-result" class="action-result" style="display:none;"></div>
                        </div>
                        
                        <!-- Bomber Action -->
                        <div id="bomber-action" class="role-call">
                            <h4>Bomber's Action</h4>
                            <p>Choose a player to plant a bomb:</p>
                            <div id="bomber-bombs-remaining" class="action-result">
                                <p><strong>Bombs remaining:</strong> <span id="bomber-bombs-count">1</span></p>
                            </div>
                            <div id="bomber-players" class="players-grid">
                                <!-- Player cards will be dynamically added here -->
                            </div>
                            <div id="bomber-code" class="code-selection" style="margin-top:15px;">
                                <p><strong>Select a code for the bomb:</strong></p>
                                <div class="code-buttons">
                                    <button class="code-btn bomber-code-btn" data-code="1">1</button>
                                    <button class="code-btn bomber-code-btn" data-code="2">2</button>
                                    <button class="code-btn bomber-code-btn" data-code="3">3</button>
                                    <button class="code-btn bomber-code-btn" data-code="4">4</button>
                                </div>
                            </div>
                            <div id="bomber-result" class="action-result" style="display:none;"></div>
                        </div>
                        
                        <button id="mafia-action-btn" class="btn btn-primary action-btn">Choose Player to Eliminate</button>
                    </div>
                    
                    <!-- 2. Detective Call -->
                    <div id="detective-call" class="night-call-section" style="display:none;">
                        <h3>2. Detective Wake Up</h3>
                        <p id="detective-status">Choose a player to investigate:</p>
                        
                        <div id="detective-players" class="players-grid">
                            <!-- Player cards will be dynamically added here -->
                        </div>
                        
                        <div id="detective-result" class="action-result" style="display:none;"></div>
                        
                        <button id="detective-done-btn" class="btn btn-primary" style="width:100%;margin-top:15px;">Detective Done</button>
                    </div>
                    
                    <!-- 3. Doctor Call -->
                    <div id="doctor-call" class="night-call-section" style="display:none;">
                        <h3>3. Doctor Wake Up</h3>
                        <p id="doctor-status">Choose a player to protect:</p>
                        
                        <div id="doctor-players" class="players-grid">
                            <!-- Player cards will be dynamically added here -->
                        </div>
                        
                        <div id="doctor-result" class="action-result" style="display:none;"></div>
                        
                        <button id="doctor-done-btn" class="btn btn-primary" style="width:100%;margin-top:15px;">Doctor Done</button>
                    </div>
                    
                    <!-- 4. Professional Call -->
                    <div id="professional-call" class="night-call-section" style="display:none;">
                        <h3>4. Professional Wake Up</h3>
                        <p id="professional-status">Choose a player to shoot:</p>
                        
                        <div id="professional-players" class="players-grid">
                            <!-- Player cards will be dynamically added here -->
                        </div>
                        
                        <div id="professional-result" class="action-result" style="display:none;"></div>
                        
                        <button id="professional-done-btn" class="btn btn-primary" style="width:100%;margin-top:15px;">Professional Done</button>
                    </div>
                    
                    <!-- 5. Gunman Call -->
                    <div id="gunman-call" class="night-call-section" style="display:none;">
                        <h3>5. Gunman Wake Up</h3>
                        <p id="gunman-status">Choose a player to give your gun and select ammunition type:</p>
                        
                        <div id="gunman-players" class="players-grid">
                            <!-- Player cards will be dynamically added here -->
                        </div>
                        
                        <div style="margin-top:15px;">
                            <p>Ammunition type:</p>
                            <div style="display:flex;gap:10px;margin-top:10px;">
                                <button id="ammo-live" class="btn" style="flex:1; height: 50px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; padding: 10px; margin-top: 0px !important;">Live Ammunition</button>
                                <button id="ammo-blank" class="btn" style="flex:1; height: 50px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; padding: 10px; margin-top: 0px !important;">Blank Ammunition</button>
                            </div>
                        </div>
                        
                        <div id="gunman-result" class="action-result" style="display:none;"></div>
                        
                        <button id="gunman-done-btn" class="btn btn-primary" style="width:100%;margin-top:15px;">Gunman Done</button>
                    </div>
                    
                    <!-- 6. Ocean Call -->
                    <div id="ocean-call" class="night-call-section" style="display:none;">
                        <h3>6. Ocean Wake Up</h3>
                        <p id="ocean-status">Choose a player for a private chat:</p>
                        
                        <div id="ocean-teammates-info" class="action-result" style="display:none;">
                            <p><strong>Ocean Teammates:</strong> <span id="ocean-teammates-list">None selected yet</span></p>
                        </div>
                        
                        <div id="ocean-select-option" style="margin-top:15px;display:none;">
                            <p><strong>Would you like to select a second teammate?</strong></p>
                            <button id="select-second-teammate-btn" class="btn btn-primary">Select a Second Teammate</button>
                            <button id="skip-second-teammate-btn" class="btn btn-secondary">Continue with First Teammate Only</button>
                        </div>
                        
                        <div id="ocean-select-players" style="margin-top:15px;">
                            <div id="ocean-players" class="player-grid"></div>
                        </div>
                        
                        <div id="ocean-chat-options" style="margin-top:15px;display:none;">
                            <p><strong>Ocean and teammates will have 30 seconds to chat privately.</strong></p>
                        </div>
                        
                        <div id="ocean-chat-timer" style="margin-top:15px;display:none;">
                            <h4>Private Chat in Progress</h4>
                            <div class="timer">
                                <div class="timer-circle">
                                    <span id="ocean-timer-display">30</span>
                                </div>
                            </div>
                            <p>Ocean and teammates are chatting privately.</p>
                            <p>Everyone else close your eyes.</p>
                            <button id="end-ocean-chat-btn" class="btn btn-primary" style="margin-top:15px;">End Chat Early</button>
                        </div>
                        
                        <button id="ocean-action-btn" class="btn btn-primary" style="margin-top:15px;display:none;">Start 30-Second Chat</button>
                    </div>
                    
                    <!-- 7. Zodiac Call -->
                    <div id="zodiac-call" class="night-call-section" style="display:none;">
                        <h3>7. Zodiac Wake Up</h3>
                        <p id="zodiac-status">Choose a player to eliminate:</p>
                        
                        <div id="zodiac-players" class="players-grid">
                            <!-- Player cards will be dynamically added here -->
                        </div>
                        
                        <div id="zodiac-result" class="action-result" style="display:none;"></div>
                        
                        <button id="zodiac-done-btn" class="btn btn-primary" style="width:100%;margin-top:15px;">Zodiac Done</button>
                    </div>
                    
                    <!-- Night Results -->
                    <div id="night-results" class="night-call-section" style="display:none;">
                        <h3>Night Results</h3>
                        <p>The night actions have been completed. The results will be announced in the morning.</p>
                        
                        <div id="results-summary" class="night-result">
                            <!-- Results will be dynamically added here -->
                        </div>
                        
                        <button id="next-day-btn" class="btn btn-success" style="width:100%;margin-top:15px;">Proceed to Morning</button>
                    </div>
                </div>
                
                <div id="game-actions" class="game-actions" style="margin-top:20px;">
                    <button id="reveal-results-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Reveal Night Results</button>
                    <button id="next-phase-btn" class="btn btn-success" style="width: 100%; margin-bottom: 15px;" disabled>Next Phase (Day)</button>
                    <button id="skip-role-btn" class="btn" style="width: 100%; margin-bottom: 15px;">Skip Current Role</button>
                    <button id="show-roles-btn" class="btn" style="width: 100%; margin-bottom: 15px;">Show Role Assignments</button>
                    <button id="reset-btn" class="btn btn-home" style="width: 100%;">Back to Home</button>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 KRS Consulting Inc.</p>
            <p>Version 1.0.2</p>
        </footer>
    </div>

    <script>
        // Global variables and state will be added in the next edit
    </script>

    <script>
        // Global variables
        let gameState = null;
        let nightState = {
            currentPhase: 'mafia',
            blocked: [],
            actions: {
                mafia: {
                    godfather: { target: null },
                    magician: { target: null },
                    bomber: { target: null, code: null }
                },
                detective: { target: null, result: null },
                doctor: { target: null },
                professional: { target: null },
                gunman: { target: null, ammoType: null },
                ocean: { 
                    target: null, 
                    chatCompleted: false,
                    teammates: [],
                    secondTeammateSelected: false 
                },
                zodiac: { target: null }
            },
            results: {
                deaths: [],
                saved: [],
                revealed: []
            }
        };
        
        let oceanTimerInterval = null;
        let oceanSecondsRemaining = 30;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Night Phase page loaded");
            
            // Load game state
            loadGameState();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Load game state from localStorage
        function loadGameState() {
            try {
                const storedGameState = localStorage.getItem('gameState');
                if (storedGameState) {
                    gameState = JSON.parse(storedGameState);
                    console.log("Game state loaded:", gameState);
                    
                    // Initialize Professional's bullets if not set
                    if (gameState.players.some(p => p.role === 'professional') && gameState.professionalBullets === undefined) {
                        gameState.professionalBullets = 2;
                    }
                    
                    // Initialize Zodiac night counter if not set
                    if (gameState.players.some(p => p.role === 'zodiac') && gameState.zodiacNightCounter === undefined) {
                        gameState.zodiacNightCounter = 0;
                    }
                    
                    // Initialize bomber bombs remaining if not set
                    if (gameState.players.some(p => p.role === 'bomber') && gameState.bomberBombsRemaining === undefined) {
                        // Check if bomb has already been used
                        const bombHasBeenUsed = Boolean(gameState.bomberAction && gameState.bomberAction.targetId);
                        gameState.bomberBombsRemaining = bombHasBeenUsed ? 0 : 1;
                    }
                    
                    // Initialize doctor self-saves if not set
                    if (gameState.players.some(p => p.role === 'doctor') && gameState.doctorSelfSavesRemaining === undefined) {
                        gameState.doctorSelfSavesRemaining = 2; // Doctor can save themselves twice
                    }
                    
                    // Update page subtitle
                    document.getElementById('night-phase-subtitle').textContent = `Night Phase - Round ${gameState.currentRound || 1}`;
                    
                    // Initialize player selections for each role
                    initializePlayerSelections();
                    
                    // Show/hide role sections based on game setup
                    updateMafiaRoleSections();
                    updateNonMafiaRoleSections();
                } else {
                    console.warn("No game state found in localStorage");
                    document.getElementById('phase-info').innerHTML = `
                        <div class="error-message">
                            <h3>Error: No game in progress</h3>
                            <p>Please start a game first.</p>
                        </div>
                    `;
                    
                    // Disable buttons
                    disableAllButtons();
                }
            } catch (error) {
                console.error("Error loading game state:", error);
                document.getElementById('phase-info').innerHTML = `
                    <div class="error-message">
                        <h3>Error loading game data</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Initialize player selections for each role's actions
        function initializePlayerSelections() {
            const rolePlayerSections = [
                { roleId: 'godfather', containerId: 'godfather-players', excludeRoles: [] },
                { roleId: 'magician', containerId: 'magician-players', excludeRoles: [] },
                { roleId: 'bomber', containerId: 'bomber-players', excludeRoles: [] },
                { roleId: 'detective', containerId: 'detective-players', excludeRoles: [] },
                { roleId: 'doctor', containerId: 'doctor-players', excludeRoles: [] },
                { roleId: 'professional', containerId: 'professional-players', excludeRoles: [] },
                { roleId: 'gunman', containerId: 'gunman-players', excludeRoles: [] },
                { roleId: 'ocean', containerId: 'ocean-players', excludeRoles: [] },
                { roleId: 'zodiac', containerId: 'zodiac-players', excludeRoles: [] }
            ];
            
            rolePlayerSections.forEach(section => {
                populatePlayerSelection(section.containerId, section.roleId, section.excludeRoles);
            });
            
            // Set up bomber code buttons
            setupBomberCodeButtons();
            
            // Set up gunman ammo type buttons
            setupGunmanAmmoButtons();
            
            // Check if bomber is inactive (dead or bomb already used)
            updateBomberSection();
        }
        
        // Populate player selection for a role's action
        function populatePlayerSelection(containerId, roleId, excludeRoles = []) {
            console.log(`Populating player selection for ${roleId} in container ${containerId}`);
            
            // Convert excludeRoles to excludePlayerIds
            const excludePlayerIds = [];
            
            if (excludeRoles && excludeRoles.length > 0) {
                // Get all players with the excluded roles
                getAlivePlayers().forEach(player => {
                    if (excludeRoles.includes(player.role)) {
                        excludePlayerIds.push(player.id);
                    }
                });
            }
            
            // Use displayPlayers to handle the actual display logic
            displayPlayers(roleId, containerId, excludePlayerIds);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners");
            
            // Reveal Results button
            const revealResultsBtn = document.getElementById('reveal-results-btn');
            if (revealResultsBtn) {
                revealResultsBtn.addEventListener('click', function() {
                    revealNightResults();
                });
            }
            
            // Next Phase button
            const nextPhaseBtn = document.getElementById('next-phase-btn');
            if (nextPhaseBtn) {
                nextPhaseBtn.addEventListener('click', function() {
                    goToNextPhase();
                });
            }
            
            // Skip role button
            const skipRoleBtn = document.getElementById('skip-role-btn');
            if (skipRoleBtn) {
                skipRoleBtn.addEventListener('click', function() {
                    console.log("Skip button clicked for current phase:", nightState.currentPhase);
                    skipCurrentRole();
                });
            }
            
            // Role action completion buttons
            const roleButtons = [
                { id: 'mafia-action-btn', role: 'mafia', nextRole: 'detective' },
                { id: 'detective-done-btn', role: 'detective', nextRole: 'doctor' },
                { id: 'doctor-done-btn', role: 'doctor', nextRole: 'professional' },
                { id: 'professional-done-btn', role: 'professional', nextRole: 'gunman' },
                { id: 'gunman-done-btn', role: 'gunman', nextRole: 'ocean' },
                { id: 'zodiac-done-btn', role: 'zodiac', nextRole: 'results' }
            ];
            
            roleButtons.forEach(button => {
                const buttonElement = document.getElementById(button.id);
                if (buttonElement) {
                    buttonElement.addEventListener('click', function() {
                        console.log(`${button.role} action completed, proceeding to ${button.nextRole}`);
                        completeRoleAction(button.role);
                        
                        if (button.nextRole === 'results') {
                            showNightResults();
                        } else {
                            showNextRole(button.nextRole);
                        }
                    });
                } else {
                    console.warn(`Button element not found: ${button.id}`);
                }
            });
            
            // Professional bullet saving
            document.getElementById('professional-done-btn').addEventListener('click', function() {
                // Only count this as using a bullet if a target was selected
                if (nightState.actions.professional.target) {
                    if (gameState.professionalBullets === 1) {
                        const resultElement = document.getElementById('professional-result');
                        if (resultElement) {
                            resultElement.innerHTML += `<p><strong>Warning:</strong> This was your last bullet!</p>`;
                            resultElement.className = 'action-result warning';
                            resultElement.style.display = 'block';
                        }
                    }
                } else {
                    // No target selected - showing message that bullet was saved
                    const resultElement = document.getElementById('professional-result');
                    if (resultElement) {
                        resultElement.innerHTML = `<p><strong>Professional chose to save the bullet.</strong></p>`;
                        resultElement.className = 'action-result success';
                        resultElement.style.display = 'block';
                    }
                }
            });
            
            // Ocean specific buttons
            const oceanActionBtn = document.getElementById('ocean-action-btn');
            if (oceanActionBtn) {
                oceanActionBtn.addEventListener('click', function() {
                    startOceanChat();
                });
            }
            
            // Add event listener for ending ocean chat early
            const endOceanChatBtn = document.getElementById('end-ocean-chat-btn');
            if (endOceanChatBtn) {
                endOceanChatBtn.addEventListener('click', function() {
                    if (oceanTimerInterval) {
                        clearInterval(oceanTimerInterval);
                        endOceanChat();
                    }
                });
            }
            
            // Select second teammate button
            const selectSecondTeammateBtn = document.getElementById('select-second-teammate-btn');
            if (selectSecondTeammateBtn) {
                selectSecondTeammateBtn.addEventListener('click', function() {
                    document.getElementById('ocean-select-option').style.display = 'none';
                    document.getElementById('ocean-select-players').style.display = 'block';
                    document.getElementById('ocean-status').textContent = 'Choose your second teammate:';
                    
                    // Display players but exclude already selected teammate
                    displayPlayers('ocean', 'ocean-players', nightState.actions.ocean.teammates);
                });
            }
            
            // Skip second teammate button
            const skipSecondTeammateBtn = document.getElementById('skip-second-teammate-btn');
            if (skipSecondTeammateBtn) {
                skipSecondTeammateBtn.addEventListener('click', function() {
                    document.getElementById('ocean-select-option').style.display = 'none';
                    document.getElementById('ocean-chat-options').style.display = 'block';
                    document.getElementById('ocean-action-btn').style.display = 'block';
                    document.getElementById('ocean-status').textContent = 'Ready for private chat with your teammate.';
                });
            }
            
            // Next day button
            const nextDayBtn = document.getElementById('next-day-btn');
            if (nextDayBtn) {
                nextDayBtn.addEventListener('click', proceedToMorning);
            }
            
            // Show roles and reset game buttons
            const showRolesBtn = document.getElementById('show-roles-btn');
            if (showRolesBtn) {
                showRolesBtn.addEventListener('click', showRoleAssignments);
            }
            
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetGame);
            }
            
            console.log("Event listeners setup complete");
        }
        
        // Validate bomber target and code selections
        function validateBomberSelections() {
            const targetSelectedId = nightState.actions.mafia.bomber.target;
            const codeSelected = nightState.actions.mafia.bomber.code;
            
            // If both a target and a code are selected, enable the done button
            const isBomberValid = targetSelectedId && codeSelected;
            
            // Use our helper function to highlight the mafia action button when bomber selection is valid
            // We need to check other mafia roles too before enabling the button
            const godfatherTarget = nightState.actions.mafia.godfather.target;
            const magicianTarget = nightState.actions.mafia.magician.target;
            
            // Enable the button if any mafia role has selected a target
            const shouldEnableButton = isBomberValid || godfatherTarget || magicianTarget;
            
            highlightDoneButton('mafia-action-btn', shouldEnableButton);
        }
        
        // Set up bomber code buttons
        function setupBomberCodeButtons() {
            const codeButtons = document.querySelectorAll('.bomber-code-btn');
            
            codeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const code = this.getAttribute('data-code');
                    
                    // Remove selected class from all code buttons
                    codeButtons.forEach(btn => btn.classList.remove('selected'));
                    
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Set bomber code
                    nightState.actions.mafia.bomber.code = code;
                    console.log(`Bomber code set to: ${code}`);
                    
                    // Check if we should enable the Mafia Done button
                    validateBomberSelections();
                });
            });
            
            // Initial validation of bomber selections
            validateBomberSelections();
        }
        
        // Set up gunman ammo type buttons
        function setupGunmanAmmoButtons() {
            document.getElementById('ammo-live').addEventListener('click', function() {
                this.classList.add('selected');
                document.getElementById('ammo-blank').classList.remove('selected');
                nightState.actions.gunman.ammoType = 'live';
                console.log('Gunman selected live ammunition');
            });
            
            document.getElementById('ammo-blank').addEventListener('click', function() {
                this.classList.add('selected');
                document.getElementById('ammo-live').classList.remove('selected');
                nightState.actions.gunman.ammoType = 'blank';
                console.log('Gunman selected blank ammunition');
            });
        }
        
        // Select a player for a role's action
        function selectPlayer(roleId, playerId) {
            console.log(`${roleId} selected player ${playerId}`);
            
            try {
                // Find the player card
                let playerCard = document.querySelector(`#${roleId}-players .player-card[data-player-id="${playerId}"]`);
                if (!playerCard) {
                    // Try alternative selector for older HTML format
                    playerCard = document.querySelector(`#${roleId}-players [data-player-id="${playerId}"]`);
                }
                
                if (!playerCard) {
                    console.error(`Cannot find player card for player ID ${playerId} and role ${roleId}`);
                    return;
                }
                
                const isDeselecting = playerCard.classList.contains('selected');
                
                // Remove selected class from all player cards in this role section
                document.querySelectorAll(`#${roleId}-players .player-card`).forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Set selection state
                if (!isDeselecting) {
                    playerCard.classList.add('selected');
                    console.log(`Player ${playerId} selected for role ${roleId}`);
                } else {
                    console.log(`Player ${playerId} deselected for role ${roleId}`);
                }
                
                // Handle role-specific actions
                switch (roleId) {
                    case 'godfather':
                        nightState.actions.mafia.godfather.target = isDeselecting ? null : playerId;
                        highlightDoneButton('mafia-action-btn', !isDeselecting);
                        break;
                        
                    case 'magician':
                        nightState.actions.mafia.magician.target = isDeselecting ? null : playerId;
                        validateMafiaSelections();
                        break;
                        
                    case 'bomber':
                        nightState.actions.mafia.bomber.target = isDeselecting ? null : playerId;
                        
                        // Show/hide code selection
                        const bomberCodeSelection = document.getElementById('bomber-code');
                        if (bomberCodeSelection) {
                            bomberCodeSelection.style.display = !isDeselecting ? 'block' : 'none';
                        }
                        
                        validateBomberSelections();
                        break;
                        
                    case 'detective':
                        nightState.actions.detective.target = isDeselecting ? null : playerId;
                        highlightDoneButton('detective-done-btn', !isDeselecting);
                        
                        // Show detective result
                        if (!isDeselecting) {
                            checkDetectiveResult(playerId);
                        } else {
                            const resultElement = document.getElementById('detective-result');
                            if (resultElement) {
                                resultElement.style.display = 'none';
                            }
                        }
                        break;
                        
                    case 'doctor':
                        nightState.actions.doctor.target = isDeselecting ? null : playerId;
                        highlightDoneButton('doctor-done-btn', !isDeselecting);
                        break;
                        
                    case 'professional':
                        nightState.actions.professional.target = isDeselecting ? null : playerId;
                        highlightDoneButton('professional-done-btn', !isDeselecting);
                        break;
                        
                    case 'gunman':
                        nightState.actions.gunman.target = isDeselecting ? null : playerId;
                        highlightDoneButton('gunman-done-btn', !isDeselecting);
                        break;
                        
                    case 'ocean':
                        // Handle Ocean's teammate selection
                        if (!isDeselecting) {
                            handleOceanSelection(playerId);
                        }
                        break;
                        
                    case 'zodiac':
                        nightState.actions.zodiac.target = isDeselecting ? null : playerId;
                        highlightDoneButton('zodiac-done-btn', !isDeselecting);
                        break;
                }
                
                // Save the updated game state to ensure selections persist
                localStorage.setItem('gameState', JSON.stringify(gameState));
                
            } catch (error) {
                console.error("Error in selectPlayer function:", error);
            }
        }
        
        // Validate if any Mafia role has made a selection
        function validateMafiaSelections() {
            const godfatherTarget = nightState.actions.mafia.godfather.target;
            const magicianTarget = nightState.actions.mafia.magician.target;
            const bomberTarget = nightState.actions.mafia.bomber.target;
            const bomberCode = nightState.actions.mafia.bomber.code;
            
            // Enable the button if any mafia role has selected a target
            // For bomber, both target and code are required
            const bomberValid = bomberTarget && bomberCode;
            const shouldEnableButton = godfatherTarget || magicianTarget || bomberValid;
            
            highlightDoneButton('mafia-action-btn', shouldEnableButton);
        }
        
        // Helper function to highlight a button when a selection is made
        function highlightDoneButton(buttonId, isSelected) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (isSelected) {
                    button.classList.add('btn-success');
                    button.classList.remove('btn-primary');
                    button.disabled = false;
                } else {
                    button.classList.add('btn-primary');
                    button.classList.remove('btn-success');
                    button.disabled = true;
                }
            }
        }
        
        // Check detective result
        function checkDetectiveResult(playerId) {
            const selectedPlayer = gameState.players.find(p => p.id === playerId);
            if (selectedPlayer) {
                const isMafia = ['magician', 'bomber', 'regular_mafia'].includes(selectedPlayer.role);
                nightState.actions.detective.result = isMafia ? 'mafia' : 'citizen';
                
                const resultElement = document.getElementById('detective-result');
                if (resultElement) {
                    resultElement.innerHTML = `<p><strong>Investigation Result:</strong> ${selectedPlayer.name} is ${isMafia ? 'a member of the Mafia' : 'not a member of the Mafia'}</p>`;
                    resultElement.className = 'action-result ' + (isMafia ? 'danger' : 'success');
                    resultElement.style.display = 'block';
                }
            }
        }
        
        // Start Ocean chat timer
        function startOceanChat() {
            // Show the timer
            document.getElementById('ocean-chat-options').style.display = 'none';
            document.getElementById('ocean-chat-timer').style.display = 'block';
            document.getElementById('ocean-action-btn').style.display = 'none';
            
            // Reset and start the timer
            oceanSecondsRemaining = 30;
            
            // Update display
            document.getElementById('ocean-timer-display').textContent = oceanSecondsRemaining;
            
            // Set interval for countdown
            oceanTimerInterval = setInterval(() => {
                oceanSecondsRemaining--;
                
                // Update display
                const timerDisplay = document.getElementById('ocean-timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = oceanSecondsRemaining;
                }
                
                // End chat when timer reaches zero
                if (oceanSecondsRemaining <= 0) {
                    clearInterval(oceanTimerInterval);
                    endOceanChat();
                }
            }, 1000);
        }
        
        // Finish Ocean chat
        function endOceanChat() {
            // Mark chat as completed
            nightState.actions.ocean.chatCompleted = true;
            
            // Hide timer
            document.getElementById('ocean-chat-timer').style.display = 'none';
            
            // Move to next role automatically
            skipCurrentRole();
        }
        
        // Complete a role's action and proceed to the next role
        function completeRoleAction(roleId) {
            console.log(`${roleId} action completed`);
            
            // For Mafia phase, all three roles act together
            if (roleId === 'mafia') {
                // Check for blocked players based on Magician's action
                if (nightState.actions.mafia.magician.target) {
                    nightState.blocked.push(nightState.actions.mafia.magician.target);
                    console.log(`Player ${nightState.actions.mafia.magician.target} has been blocked by Magician`);
                }
            }
            
            nightState.currentPhase = roleId;
        }
        
        // Show the next role's actions
        function showNextRole(nextRoleId) {
            console.log(`Showing next role: ${nextRoleId}`);
            
            // Hide all role sections
            document.querySelectorAll('.night-call-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Always show the Skip Current Role button
            const skipButton = document.getElementById('skip-role-btn');
            if (skipButton) {
                skipButton.style.display = 'block';
                skipButton.disabled = false;
                
                // Update button text to be more specific
                skipButton.textContent = `Skip ${capitalizeFirstLetter(nextRoleId)}`;
            }
            
            // Update current phase 
            nightState.currentPhase = nextRoleId;
            
            // Handle role-specific initializations
            switch (nextRoleId) {
                case 'godfather':
                case 'magician':
                case 'bomber':
                    // Show the mafia section
                    document.getElementById('mafia-call').style.display = 'block';
                    break;
                    
                case 'detective':
                    document.getElementById('detective-call').style.display = 'block';
                    break;
                    
                case 'doctor':
                    document.getElementById('doctor-call').style.display = 'block';
                    break;
                    
                case 'professional':
                    document.getElementById('professional-call').style.display = 'block';
                    break;
                    
                case 'gunman':
                    document.getElementById('gunman-call').style.display = 'block';
                    break;
                    
                case 'ocean':
                    showOceanSection();
                    break;
                    
                case 'zodiac':
                    document.getElementById('zodiac-call').style.display = 'block';
                    break;
            }
            
            // Check if this role exists in the game
            const roleExists = gameState.players.some(p => p.role === nextRoleId);
            
            // If role doesn't exist, skip to the next role
            if (!roleExists) {
                console.log(`Role ${nextRoleId} does not exist in this game, skipping...`);
                skipRoleBasedOnId(nextRoleId);
                return;
            }
            
            // Check if role is blocked or dead
            if (isRoleBlocked(nextRoleId) || !isRoleAlive(nextRoleId)) {
                // Update status message
                let statusMessage = '';
                if (isRoleBlocked(nextRoleId)) {
                    statusMessage = `${capitalizeFirstLetter(nextRoleId)} has been blocked and cannot perform any actions.`;
                } else {
                    statusMessage = `${capitalizeFirstLetter(nextRoleId)} is no longer alive. This is just for show.`;
                }
                
                const statusElement = document.getElementById(`${nextRoleId}-status`);
                if (statusElement) {
                    statusElement.textContent = statusMessage;
                }
                
                // Show blocked/dead message
                const resultElement = document.getElementById(`${nextRoleId}-result`);
                if (resultElement) {
                    resultElement.innerHTML = `<p><strong>${isRoleBlocked(nextRoleId) ? 
                        `${capitalizeFirstLetter(nextRoleId)} is blocked tonight!` : 
                        `${capitalizeFirstLetter(nextRoleId)} is no longer alive!`}</strong></p>`;
                    resultElement.className = 'action-result ' + (isRoleBlocked(nextRoleId) ? 'warning' : 'danger');
                    resultElement.style.display = 'block';
                }
                
                // Disable player selection
                disablePlayerSelection(nextRoleId);
            } else {
                // Role is active, ensure player cards are properly displayed
                populatePlayerSelection(`${nextRoleId}-players`, nextRoleId);
            }
        }
        
        // Check if a role is alive
        function isRoleAlive(roleId) {
            return getAlivePlayers().some(p => p.role === roleId);
        }
        
        // Skip to next role based on current role ID
        function skipRoleBasedOnId(currentRoleId) {
            switch(currentRoleId) {
                case 'detective':
                    showNextRole('doctor');
                    break;
                case 'doctor':
                    showNextRole('professional');
                    break;
                case 'professional':
                    showNextRole('gunman');
                    break;
                case 'gunman':
                    showNextRole('ocean');
                    break;
                case 'ocean':
                    showNextRole('zodiac');
                    break;
                case 'zodiac':
                    showNightResults();
                    break;
                default:
                    showNightResults();
            }
        }
        
        // Check if a role is blocked based on player ID
        function isRoleBlocked(roleId) {
            // Find player with the role
            const player = gameState.players.find(p => p.role === roleId);
            
            if (player) {
                // Check if player is in the blocked list
                return nightState.blocked.includes(player.id);
            }
            
            return false;
        }
        
        // Disable player selection for a blocked role
        function disablePlayerSelection(roleId) {
            const container = document.getElementById(`${roleId}-players`);
            if (container) {
                container.classList.add('disabled');
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
            }
        }
        
        // Skip the current role
        function skipCurrentRole() {
            switch(nightState.currentPhase) {
                case 'mafia':
                    showNextRole('detective');
                    break;
                case 'detective':
                    showNextRole('doctor');
                    break;
                case 'doctor':
                    showNextRole('professional');
                    break;
                case 'professional':
                    showNextRole('gunman');
                    break;
                case 'gunman':
                    showNextRole('ocean');
                    break;
                case 'ocean':
                    showNextRole('zodiac');
                    break;
                case 'zodiac':
                    showNightResults();
                    break;
            }
        }
        
        // Show night results
        function showNightResults() {
            // Hide all role sections
            document.querySelectorAll('.night-call-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Hide the Skip Current Role button since it's no longer needed
            document.getElementById('skip-role-btn').style.display = 'none';
            
            // Calculate night results
            calculateNightResults();
            
            // Prepare results summary
            let resultsHtml = `<h4>Night ${gameState.currentRound} Summary</h4>`;
            
            // This is just a preview for the moderator, actual results will be announced in the morning
            resultsHtml += `<p>The following results will be announced in the morning:</p>`;
            resultsHtml += `<ul style="margin-left:20px;">`;
            
            // Deaths - without revealing the reason for elimination
            if (nightState.results.deaths.length > 0) {
                nightState.results.deaths.forEach(death => {
                    // Skip Ocean death if it's related to selecting a Mafia/Zodiac teammate
                    if (death.role === 'ocean' && death.reason && death.reason.includes('Mafia or Zodiac player as teammate')) {
                        // This will only be shown in the moderator notes
                        return;
                    }
                    
                    resultsHtml += `<li>${death.name} ${death.saved ? 'was targeted but saved by the Doctor' : 'will be eliminated'}</li>`;
                });
            } else {
                resultsHtml += `<li>No players will be eliminated tonight</li>`;
            }
            
            // Bomber's bomb placement
            if (nightState.actions.mafia.bomber.target && 
                nightState.actions.mafia.bomber.code && 
                !isRoleBlocked('bomber')) {
                
                const bomberAlive = getAlivePlayers().some(p => p.role === 'bomber');
                const bombHasBeenUsed = Boolean(gameState.bomberAction && gameState.bomberAction.targetId);
                
                // Only proceed if bomber is alive and hasn't used their bomb yet
                if (bomberAlive && !bombHasBeenUsed) {
                    const targetPlayer = gameState.players.find(p => p.id === nightState.actions.mafia.bomber.target);
                    
                    if (targetPlayer) {
                        // Store bomb info in game state
                        gameState.bomberAction = {
                            targetId: targetPlayer.id,
                            code: nightState.actions.mafia.bomber.code,
                            placedInRound: gameState.currentRound
                        };
                        
                        // Decrease bombs remaining count
                        gameState.bomberBombsRemaining = Math.max(0, (gameState.bomberBombsRemaining || 1) - 1);
                        
                        resultsHtml += `<li>A bomb has been placed on ${targetPlayer.name} with code ${nightState.actions.mafia.bomber.code}</li>`;
                    }
                }
            }

            resultsHtml += `</ul>`;
            
            // Special notes for moderator
            resultsHtml += `<div style="margin-top:15px;padding:10px;background-color:var(--card-bg-darker, #2a2a2a);border-radius:8px;">`;
            resultsHtml += `<h4>Moderator Notes:</h4>`;
            
            // Professional bullets remaining
            const professionalAlive = getAlivePlayers().some(p => p.role === 'professional');
            if (professionalAlive) {
                resultsHtml += `<p><strong>Professional Bullets Remaining:</strong> ${gameState.professionalBullets || 0}</p>`;
            }
            
            // Bomber bombs remaining
            const bomberAlive = getAlivePlayers().some(p => p.role === 'bomber');
            if (bomberAlive) {
                resultsHtml += `<p><strong>Bomber Bombs Remaining:</strong> ${gameState.bomberBombsRemaining || 0}</p>`;
            }
            
            // Zodiac status
            const zodiacAlive = getAlivePlayers().some(p => p.role === 'zodiac');
            if (zodiacAlive) {
                resultsHtml += `<p><strong>Zodiac Status:</strong> ${isZodiacActiveNight() ? 'Could kill tonight' : 'Could not kill tonight'}</p>`;
                resultsHtml += `<p><strong>Zodiac Night Counter:</strong> ${gameState.zodiacNightCounter || 0}</p>`;
            }
            
            // Ocean teammates info - only show in moderator notes
            if (!isRoleBlocked('ocean') && isRoleAlive('ocean')) {
                const oceanTeammates = gameState.oceanTeammates || [];
                if (oceanTeammates.length > 0) {
                    const teammateNames = oceanTeammates.map(id => {
                        const player = gameState.players.find(p => p.id === id);
                        return player ? player.name : 'Unknown';
                    }).join(', ');
                    
                    resultsHtml += `<p><strong>Ocean's Teammates:</strong> ${teammateNames}</p>`;
                    
                    // Add information about Ocean's chat
                    if (nightState.actions.ocean.chatCompleted) {
                        resultsHtml += `<p><strong>Ocean Chat:</strong> Ocean had a private 30-second chat with teammates</p>`;
                    }
                    
                    // Add information if Ocean will be eliminated due to choosing Mafia/Zodiac
                    const oceanDeathResult = nightState.results.deaths.find(death => 
                        death.role === 'ocean' && death.reason && death.reason.includes('Mafia or Zodiac'));
                    
                    if (oceanDeathResult) {
                        resultsHtml += `<p><strong>Ocean Death:</strong> Ocean selected a Mafia or Zodiac player and will be eliminated</p>`;
                    }
                }
            }
            
            resultsHtml += `</div>`;
            
            // Display results
            const resultsSection = document.getElementById('night-results');
            const resultsSummary = document.getElementById('results-summary');
            
            if (resultsSection && resultsSummary) {
                resultsSummary.innerHTML = resultsHtml;
                resultsSection.style.display = 'block';
            }
            
            // Increment the game round
            gameState.currentRound++;
            
            // Update game phase to morning
            gameState.gamePhase = 'day';
            
            // Save updated game state
            localStorage.setItem('gameState', JSON.stringify(gameState));
            
            // Enable the next day button
            document.getElementById('next-day-btn').style.display = 'block';
        }
        
        // Calculate night results based on role actions
        function calculateNightResults() {
            nightState.results.deaths = [];
            nightState.results.saved = [];
            nightState.results.revealed = [];
            
            // Get alive players
            const alivePlayers = getAlivePlayers();
            
            // 1. Process Mafia's target (Godfather)
            if (nightState.actions.mafia.godfather.target && !isRoleBlocked('godfather')) {
                const targetPlayer = gameState.players.find(p => p.id === nightState.actions.mafia.godfather.target);
                
                if (targetPlayer) {
                    const isDoctorProtected = isPlayerProtectedByDoctor(targetPlayer.id);
                    
                    // Add to deaths or saved list
                    if (isDoctorProtected) {
                        nightState.results.saved.push({
                            id: targetPlayer.id,
                            name: targetPlayer.name,
                            role: targetPlayer.role,
                            savedBy: 'doctor'
                        });
                    } else {
                        nightState.results.deaths.push({
                            id: targetPlayer.id,
                            name: targetPlayer.name,
                            role: targetPlayer.role,
                            saved: false,
                            killedBy: 'mafia'
                        });
                    }
                }
            }
            
            // 2. Process Zodiac's target
            if (nightState.actions.zodiac.target && 
                !isRoleBlocked('zodiac') && 
                isRoleAlive('zodiac') && 
                isZodiacActiveNight()) {
                
                const targetPlayer = gameState.players.find(p => p.id === nightState.actions.zodiac.target);
                
                if (targetPlayer) {
                    const isDoctorProtected = isPlayerProtectedByDoctor(targetPlayer.id);
                    
                    // Add to deaths or saved list
                    if (isDoctorProtected) {
                        nightState.results.saved.push({
                            id: targetPlayer.id,
                            name: targetPlayer.name,
                            role: targetPlayer.role,
                            savedBy: 'doctor'
                        });
                    } else {
                        // Check if this player is already in deaths list (killed by Mafia)
                        const existingDeath = nightState.results.deaths.find(d => d.id === targetPlayer.id);
                        
                        if (!existingDeath) {
                            nightState.results.deaths.push({
                                id: targetPlayer.id,
                                name: targetPlayer.name,
                                role: targetPlayer.role,
                                saved: false,
                                killedBy: 'zodiac'
                            });
                        }
                    }
                }
                
                // Increment the Zodiac night counter
                gameState.zodiacNightCounter = (gameState.zodiacNightCounter || 0) + 1;
            }
            
            // 3. Process Professional's target
            if (nightState.actions.professional.target && 
                !isRoleBlocked('professional') && 
                hasProfessionalBullets()) {
                
                const targetPlayer = gameState.players.find(p => p.id === nightState.actions.professional.target);
                
                if (targetPlayer) {
                    // Check if they are Mafia
                    const isMafia = ['godfather', 'magician', 'bomber', 'regular_mafia', 'zodiac'].includes(targetPlayer.role);
                    
                    // If Professional shoots incorrectly (non-Mafia), they die
                    if (!isMafia) {
                        const professionalPlayer = gameState.players.find(p => p.role === 'professional');
                        
                        if (professionalPlayer) {
                            nightState.results.deaths.push({
                                id: professionalPlayer.id,
                                name: professionalPlayer.name,
                                role: professionalPlayer.role,
                                saved: false,
                                killedBy: 'self',
                                reason: 'Professional shot a non-Mafia player'
                            });
                        }
                    } else {
                        // Check if this player is already in deaths list
                        const existingDeath = nightState.results.deaths.find(d => d.id === targetPlayer.id);
                        
                        if (!existingDeath) {
                            nightState.results.deaths.push({
                                id: targetPlayer.id,
                                name: targetPlayer.name,
                                role: targetPlayer.role,
                                saved: false,
                                killedBy: 'professional'
                            });
                        }
                    }
                    
                    // Decrement professional bullets
                    gameState.professionalBullets = (gameState.professionalBullets || 0) - 1;
                }
            }
            
            // 4. Process Ocean's special behavior
            // Check if Ocean selected a new teammate (second teammate) this night
            if (nightState.actions.ocean.secondTeammateSelected && !isRoleBlocked('ocean') && isRoleAlive('ocean')) {
                const newTeammateId = nightState.actions.ocean.teammates[1];
                if (newTeammateId) {
                    const newTeammate = gameState.players.find(p => p.id === newTeammateId);
                    if (newTeammate) {
                        const isDangerousRole = ['godfather', 'magician', 'bomber', 'zodiac'].includes(newTeammate.role);
                        if (isDangerousRole) {
                            // Ocean gets eliminated if they choose Mafia or Zodiac as a teammate
                            const oceanPlayer = gameState.players.find(p => p.role === 'ocean');
                            if (oceanPlayer && !nightState.results.deaths.some(d => d.id === oceanPlayer.id)) {
                                nightState.results.deaths.push({
                                    id: oceanPlayer.id,
                                    name: oceanPlayer.name,
                                    role: oceanPlayer.role,
                                    saved: false,
                                    killedBy: 'self',
                                    reason: 'Ocean selected a Mafia or Zodiac player as teammate'
                                });
                            }
                        }
                    }
                }
            }
            
            // Save night results in game state
            gameState.lastNightResults = {
                deaths: nightState.results.deaths,
                saved: nightState.results.saved,
                revealed: nightState.results.revealed
            };
            
            // Update game state with eliminated players
            if (nightState.results.deaths.length > 0) {
                if (!gameState.eliminatedPlayers) {
                    gameState.eliminatedPlayers = [];
                }
                
                // Add night deaths to eliminated players
                nightState.results.deaths.forEach(death => {
                    // Check if not already in eliminated
                    const alreadyEliminated = gameState.eliminatedPlayers.some(p => p.id === death.id);
                    
                    if (!alreadyEliminated) {
                        gameState.eliminatedPlayers.push({
                            id: death.id,
                            name: death.name,
                            role: death.role,
                            eliminatedInRound: gameState.currentRound,
                            eliminatedInPhase: 'night'
                        });
                    }
                });
            }
            
            // Save updated game state
            localStorage.setItem('gameState', JSON.stringify(gameState));
        }
        
        // Proceed to morning phase
        function proceedToMorning() {
            console.log('Proceeding to morning phase');
            
            // Update game state with night results
            gameState.nightResults = nightState.results;
            
            // Make sure Professional's bullet count is saved in the game state
            // (it might have been updated during the night)
            
            // Update Zodiac's night counter
            if (!gameState.zodiacNightCounter) {
                gameState.zodiacNightCounter = 0;
            }
            gameState.zodiacNightCounter++;
            
            // Initialize bomberBombsRemaining if it doesn't exist yet
            if (gameState.bomberBombsRemaining === undefined) {
                // Check if bomber exists in the game
                const bomberExists = gameState.players.some(p => p.role === 'bomber');
                gameState.bomberBombsRemaining = bomberExists ? 1 : 0;
            }
            
            // If a bomb was placed this night, decrement the bomb counter
            if (gameState.bomberAction && gameState.bomberAction.targetId && gameState.bomberAction.code) {
                // Ensure the counter doesn't go below 0
                gameState.bomberBombsRemaining = 0;
            }
            
            // Update doctor's self-save counter if doctor saved themselves
            if (nightState.actions.doctor.target) {
                const doctorPlayer = gameState.players.find(p => p.role === 'doctor');
                if (doctorPlayer && doctorPlayer.id === nightState.actions.doctor.target) {
                    // Initialize self-saves counter if not set
                    if (gameState.doctorSelfSavesRemaining === undefined) {
                        gameState.doctorSelfSavesRemaining = 2;
                    }
                    
                    // Decrement counter (ensuring it doesn't go below 0)
                    gameState.doctorSelfSavesRemaining = Math.max(0, gameState.doctorSelfSavesRemaining - 1);
                    console.log(`Doctor used a self-save. Remaining: ${gameState.doctorSelfSavesRemaining}`);
                }
            }
            
            // Increment round if needed
            if (!gameState.currentRound) {
                gameState.currentRound = 1;
            } else {
                gameState.currentRound++;
            }
            
            // Update game phase
            gameState.gamePhase = 'day';
            
            // Add any eliminated players to the game state
            if (!gameState.eliminatedPlayers) {
                gameState.eliminatedPlayers = [];
            }
            
            nightState.results.deaths.forEach(death => {
                gameState.eliminatedPlayers.push({
                    id: death.id,
                    name: death.name,
                    role: death.role,
                    eliminatedInRound: gameState.currentRound - 1,
                    eliminatedInPhase: 'night'
                });
            });
            
            // Store gunman's action (not announced, but processed)
            if (nightState.actions.gunman.target && !isRoleBlocked('gunman')) {
                gameState.gunmanAction = {
                    targetId: nightState.actions.gunman.target,
                    ammoType: nightState.actions.gunman.ammoType
                };
            }
            
            // Store bomber's action (only bomb placement is announced)
            if (nightState.actions.mafia.bomber.target && 
                nightState.actions.mafia.bomber.code && 
                !isRoleBlocked('bomber')) {
                
                const bomberAlive = getAlivePlayers().some(p => p.role === 'bomber');
                const bombHasBeenUsed = Boolean(gameState.bomberAction && gameState.bomberAction.targetId);
                
                // Only save bomber action if bomber is alive and hasn't used their bomb yet
                if (bomberAlive && !bombHasBeenUsed) {
                    gameState.bomberAction = {
                        targetId: nightState.actions.mafia.bomber.target,
                        code: nightState.actions.mafia.bomber.code
                    };
                }
            }
            
            // Check for game-ending conditions
            const gameEndResult = checkGameEndingConditions();
            
            if (gameEndResult.gameOver) {
                // Game has ended, redirect to the game over page or show end game dialog
                gameState.gameOver = true;
                gameState.winningTeam = gameEndResult.winningTeam;
                gameState.endReason = gameEndResult.reason;
                
                // Save game state
                localStorage.setItem('gameState', JSON.stringify(gameState));
                
                // If it's a Chaos Day (3 players with at least one Mafia/Zodiac), go to Chaos Day page
                if (gameEndResult.chaosDay) {
                    gameState.chaosDay = true;
                    localStorage.setItem('gameState', JSON.stringify(gameState));
                    window.location.href = 'chaos-day.html';
                    return;
                }
                
                // Otherwise, go to game over page
                window.location.href = 'game-over.html';
                return;
            }
            
            // Save game state
            localStorage.setItem('gameState', JSON.stringify(gameState));
            
            // Redirect to day phase
            window.location.href = 'day-phase.html';
        }
        
        // Check for game-ending conditions
        function checkGameEndingConditions() {
            const alivePlayers = getAlivePlayers();
            
            // Get counts of each team
            const mafiaCount = alivePlayers.filter(p => 
                ['godfather', 'magician', 'bomber', 'regular_mafia'].includes(p.role)
            ).length;
            
            const townCount = alivePlayers.filter(p => 
                !['godfather', 'magician', 'bomber', 'regular_mafia', 'zodiac'].includes(p.role)
            ).length;
            
            const zodiacAlive = alivePlayers.some(p => p.role === 'zodiac');
            
            // Check if zodiac exists in the game at all
            const zodiacExists = gameState.players.some(p => p.role === 'zodiac');

            // 0. No Mafia or Zodiac players are left - Town wins
            if (mafiaCount === 0 && !zodiacAlive) {
                return {
                    gameOver: true,
                    winningTeam: 'town',
                    reason: 'All Mafia and Zodiac players have been eliminated - Town wins!',
                    chaosDay: false
                };
            }
            
            // 1. Only one player left
            if (alivePlayers.length === 1) {
                const lastPlayer = alivePlayers[0];
                let winningTeam = 'town'; // Default
                
                // Determine winning team based on last player
                if (['godfather', 'magician', 'bomber', 'regular_mafia'].includes(lastPlayer.role)) {
                    winningTeam = 'mafia';
                } else if (lastPlayer.role === 'zodiac') {
                    winningTeam = 'zodiac';
                }
                
                return {
                    gameOver: true,
                    winningTeam: winningTeam,
                    reason: `Only ${lastPlayer.name} (${capitalizeFirstLetter(lastPlayer.role)}) remains alive.`,
                    chaosDay: false
                };
            }
            
            // 2. Two players left
            if (alivePlayers.length === 2) {
                // If Zodiac is one of them, Zodiac wins
                if (zodiacAlive) {
                    return {
                        gameOver: true,
                        winningTeam: 'zodiac',
                        reason: 'Zodiac has reached final 2 players and wins!',
                        chaosDay: false
                    };
                }
                
                // If both are town, town wins
                if (mafiaCount === 0) {
                    return {
                        gameOver: true,
                        winningTeam: 'town',
                        reason: 'Only townsfolk remain - Town wins!',
                        chaosDay: false
                    };
                }
                
                // If at least one is Mafia, Mafia wins
                if (mafiaCount > 0) {
                    return {
                        gameOver: true,
                        winningTeam: 'mafia',
                        reason: 'Mafia has reached parity with Town - Mafia wins!',
                        chaosDay: false
                    };
                }
            }
            
            // 3. Mafia equals or outnumbers town (and no Zodiac)
            if (mafiaCount >= townCount && !zodiacAlive && alivePlayers.length > 2) {
                return {
                    gameOver: true,
                    winningTeam: 'mafia',
                    reason: 'Mafia has reached parity with or outnumbers Town - Mafia wins!',
                    chaosDay: false
                };
            }
            
            // 4. Chaos Day - exactly 3 players with at least one Mafia or Zodiac
            if (alivePlayers.length === 3 && (mafiaCount > 0 || zodiacAlive)) {
                return {
                    gameOver: true,
                    winningTeam: 'undecided', // To be determined in Chaos Day
                    reason: 'Three players remain with at least one Mafia or Zodiac - Chaos Day!',
                    chaosDay: true
                };
            }
            
            // Game continues
            return {
                gameOver: false
            };
        }
        
        // Show role assignments
        function showRoleAssignments() {
            window.location.href = 'role-assignments.html';
        }
        
        // Reset the game and return to home
        function resetGame() {
            // Clear game state
            localStorage.removeItem('gameState');
            localStorage.removeItem('defenseState');
            
            // Redirect to home page
            window.location.href = 'index.html';
        }
        
        // Helper function to get alive players
        function getAlivePlayers() {
            if (!gameState || !gameState.players) return [];
            
            // If eliminatedPlayers doesn't exist, initialize it
            if (!gameState.eliminatedPlayers) {
                gameState.eliminatedPlayers = [];
            }
            
            // Return players who are not in the eliminatedPlayers array
            return gameState.players.filter(player => 
                !gameState.eliminatedPlayers.some(eliminated => eliminated.id === player.id)
            );
        }
        
        // Helper function to disable all buttons
        function disableAllButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = true;
            });
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        
        // Create a role card for the active role display
        function createRoleCard(player) {
            const roleCard = document.createElement('div');
            roleCard.className = 'active-role-card';
            
            const defaultImage = 'images/default-avatar.svg';
            const imageUrl = player.photo_url || defaultImage;
            
            roleCard.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${player.name}" 
                     onerror="this.onerror=null; this.src='${defaultImage}';">
                <h4>${player.name}</h4>
                <p class="role-name">${capitalizeFirstLetter(player.role)}</p>
            `;
            
            return roleCard;
        }
        
        // Show/hide Mafia role sections based on game setup
        function updateMafiaRoleSections() {
            const allPlayers = gameState.players || [];
            const alivePlayers = getAlivePlayers();
            
            // Check if any Mafia members are alive
            const hasAliveMafia = alivePlayers.some(p => 
                ['godfather', 'regular_mafia', 'magician', 'bomber'].includes(p.role)
            );
            
            // Check if magician was in the original game setup
            const magicianExists = allPlayers.some(p => p.role === 'magician');
            const magicianAlive = alivePlayers.some(p => p.role === 'magician');
            
            // Check if bomber was in the original game setup
            const bomberExists = allPlayers.some(p => p.role === 'bomber');
            const bomberAlive = alivePlayers.some(p => p.role === 'bomber');
            
            // Godfather section - make inactive if no Mafia members are alive
            const godfatherAction = document.getElementById('godfather-action');
            if (godfatherAction) {
                if (!hasAliveMafia) {
                    // If no Mafia are alive, disable the godfather section
                    godfatherAction.classList.add('inactive-role');
                    // Add warning message if not already present
                    if (!godfatherAction.querySelector('.no-mafia-indicator')) {
                        const godfatherStatus = document.createElement('div');
                        godfatherStatus.className = 'action-result warning no-mafia-indicator';
                        godfatherStatus.innerHTML = '<p><strong>No Mafia members are alive. This action cannot be performed.</strong></p>';
                        godfatherAction.appendChild(godfatherStatus);
                    }
                    
                    // Disable Godfather player selection
                    const godfatherPlayers = document.getElementById('godfather-players');
                    if (godfatherPlayers) {
                        godfatherPlayers.classList.add('disabled');
                        godfatherPlayers.style.opacity = '0.5';
                        godfatherPlayers.style.pointerEvents = 'none';
                    }
                }
            }
            
            // Magician section
            const magicianAction = document.getElementById('magician-action');
            if (magicianAction) {
                if (!magicianExists) {
                    // If magician was never in the game, hide the section
                    magicianAction.style.display = 'none';
                } else if (!magicianAlive) {
                    // If magician is dead, show section but disable player selection
                    magicianAction.classList.add('inactive-role');
                    const magicianStatus = document.createElement('div');
                    magicianStatus.className = 'action-result warning';
                    magicianStatus.innerHTML = '<p>Magician is no longer alive. This action cannot be performed.</p>';
                    magicianAction.appendChild(magicianStatus);
                }
            }
            
            // Bomber section - moved most of the logic to updateBomberSection()
            updateBomberSection();
            
            // Update Godfather section title based on inheritance
            const activeGodfather = getActiveGodfather();
            
            if (godfatherAction && activeGodfather) {
                const godfatherHeader = godfatherAction.querySelector('h4');
                if (godfatherHeader) {
                    if (activeGodfather.role === 'godfather') {
                        godfatherHeader.textContent = "Godfather's Action";
                    } else if (activeGodfather.role === 'magician') {
                        godfatherHeader.textContent = "Magician's Action (as Godfather)";
                    } else if (activeGodfather.role === 'bomber') {
                        godfatherHeader.textContent = "Bomber's Action (as Godfather)";
                    } else {
                        godfatherHeader.textContent = "Mafia's Action (as Godfather)";
                    }
                }
            }
        }
        
        // Update Bomber section to mark it inactive if bomb is used or bomber is dead
        function updateBomberSection() {
            const allPlayers = gameState.players || [];
            const alivePlayers = getAlivePlayers();
            
            // Check if bomber was in the original game setup
            const bomberExists = allPlayers.some(p => p.role === 'bomber');
            const bomberAlive = alivePlayers.some(p => p.role === 'bomber');
            const bombHasBeenUsed = Boolean(gameState.bomberAction && gameState.bomberAction.targetId);
            
            // Initialize bomberBombsRemaining if it doesn't exist yet
            if (gameState.bomberBombsRemaining === undefined) {
                gameState.bomberBombsRemaining = bomberExists && bomberAlive && !bombHasBeenUsed ? 1 : 0;
            }
            
            // Bomber section
            const bomberAction = document.getElementById('bomber-action');
            if (bomberAction) {
                // Update title to show bombs remaining
                const bomberHeader = bomberAction.querySelector('h4');
                if (bomberHeader) {
                    bomberHeader.textContent = `Bomber's Action (${gameState.bomberBombsRemaining} bomb${gameState.bomberBombsRemaining !== 1 ? 's' : ''} left)`;
                }
                
                if (!bomberExists) {
                    // If bomber was never in the game, hide the section
                    bomberAction.style.display = 'none';
                } else if (!bomberAlive || bombHasBeenUsed || gameState.bomberBombsRemaining === 0) {
                    // Mark the bomber section as inactive if bomber is dead, bomb used, or no bombs left
                    bomberAction.classList.add('inactive-role');
                    
                    // Add warning message if not already present
                    if (!bomberAction.querySelector('.bomb-used-indicator')) {
                        const bomberStatus = document.createElement('div');
                        bomberStatus.className = 'action-result warning bomb-used-indicator';
                        
                        if (!bomberAlive) {
                            bomberStatus.innerHTML = '<p><strong>Bomber is no longer alive. This action cannot be performed.</strong></p>';
                        } else if (bombHasBeenUsed || gameState.bomberBombsRemaining === 0) {
                            bomberStatus.innerHTML = '<p><strong>Bomb has already been placed. No more bombs available.</strong></p>';
                        }
                        
                        bomberAction.appendChild(bomberStatus);
                    }
                    
                    // Disable bomber player selection
                    const bomberPlayers = document.getElementById('bomber-players');
                    if (bomberPlayers) {
                        bomberPlayers.classList.add('disabled');
                        bomberPlayers.style.opacity = '0.5';
                        bomberPlayers.style.pointerEvents = 'none';
                    }
                    
                    // Disable bomber code buttons
                    const bomberCode = document.getElementById('bomber-code');
                    if (bomberCode) {
                        bomberCode.classList.add('disabled');
                        bomberCode.style.opacity = '0.5';
                        bomberCode.style.pointerEvents = 'none';
                    }
                }
            }
        }
        
        // Update non-Mafia role sections based on game setup
        function updateNonMafiaRoleSections() {
            const allPlayers = gameState.players || [];
            const alivePlayers = getAlivePlayers();
            
            // List of roles to check
            const rolesToCheck = [
                { id: 'detective', elementId: 'detective-call' },
                { id: 'doctor', elementId: 'doctor-call' },
                { id: 'professional', elementId: 'professional-call' },
                { id: 'gunman', elementId: 'gunman-call' },
                { id: 'ocean', elementId: 'ocean-call' },
                { id: 'zodiac', elementId: 'zodiac-call' }
            ];
            
            rolesToCheck.forEach(role => {
                // Check if role exists in game setup
                const roleExists = allPlayers.some(p => p.role === role.id);
                const roleAlive = alivePlayers.some(p => p.role === role.id);
                
                const roleSection = document.getElementById(role.elementId);
                if (roleSection) {
                    // Special case for Professional - check if bullets are used up
                    if (role.id === 'professional') {
                        // Initialize bullets count if it doesn't exist
                        if (!gameState.professionalBullets) {
                            gameState.professionalBullets = 2;
                        }
                        
                        // If professional has used both bullets, disable the section
                        if (gameState.professionalBullets <= 0) {
                            roleSection.classList.add('inactive-role');
                            if (!roleSection.querySelector('.action-result.warning')) {
                                const statusElement = document.createElement('div');
                                statusElement.className = 'action-result warning';
                                statusElement.innerHTML = `<p>Professional has used all bullets. No more shots available.</p>`;
                                roleSection.appendChild(statusElement);
                            }
                            // Disable player selection
                            disablePlayerSelection('professional');
                            return;
                        }
                    }
                    
                    // Special case for Doctor - update self-save counter
                    if (role.id === 'doctor') {
                        // Make sure self-saves counter is initialized
                        if (gameState.doctorSelfSavesRemaining === undefined) {
                            gameState.doctorSelfSavesRemaining = 2;
                        }
                        
                        // Update doctor section header with self-saves counter
                        const heading = roleSection.querySelector('h3');
                        if (heading) {
                            heading.textContent = `3. Doctor Wake Up (${gameState.doctorSelfSavesRemaining} self-save${gameState.doctorSelfSavesRemaining !== 1 ? 's' : ''} left)`;
                        }
                        
                        // Add warning if no self-saves left
                        if (gameState.doctorSelfSavesRemaining <= 0) {
                            if (!roleSection.querySelector('.self-save-warning')) {
                                const warningElement = document.createElement('div');
                                warningElement.className = 'action-result warning self-save-warning';
                                warningElement.innerHTML = `<p><strong>Warning:</strong> You have used all your self-saves. You can no longer protect yourself.</p>`;
                                
                                // Insert after the status paragraph
                                const statusElement = document.getElementById('doctor-status');
                                if (statusElement && statusElement.nextSibling) {
                                    roleSection.insertBefore(warningElement, statusElement.nextSibling);
                                } else {
                                    roleSection.appendChild(warningElement);
                                }
                            }
                            
                            // Disable self-selection for doctor
                            disableDoctorSelfSelection();
                        }
                    }
                    
                    // Special case for Zodiac - check if this is an active Zodiac night
                    if (role.id === 'zodiac') {
                        if (!shouldZodiacActTonight()) {
                            roleSection.classList.add('inactive-role');
                            if (!roleSection.querySelector('.action-result.warning')) {
                                const statusElement = document.createElement('div');
                                statusElement.className = 'action-result warning';
                                statusElement.innerHTML = `<p>Zodiac does not act tonight. Zodiac acts on Night 1 and then every other night.</p>`;
                                roleSection.appendChild(statusElement);
                            }
                            // Disable player selection
                            disablePlayerSelection('zodiac');
                            return;
                        }
                    }
                    
                    // If there's a bodyguard in the game
                    const bodyguardPlayer = getAlivePlayers().find(p => p.role === 'bodyguard');
                    
                    // Special case for Zodiac
                    if (role.id === 'zodiac') {
                        const zodiacPlayer = getAlivePlayers().find(p => p.role === 'zodiac');
                        
                        // If Zodiac doesn't act tonight or is dead, disable section
                        if (!shouldZodiacActTonight() || !zodiacPlayer) {
                            const reasonText = !shouldZodiacActTonight() 
                                ? `Zodiac does not act tonight. Zodiac acts on Night 1 and then every other night.`
                                : `Zodiac is no longer alive. This action cannot be performed.`;
                            
                            roleSection.classList.add('inactive-role');
                            if (!roleSection.querySelector('.action-result.warning')) {
                                const statusElement = document.createElement('div');
                                statusElement.className = 'action-result warning';
                                statusElement.innerHTML = `<p>${reasonText}</p>`;
                                roleSection.appendChild(statusElement);
                            }
                            // Disable player selection
                            disablePlayerSelection('zodiac');
                            return;
                        }
                        
                        // Add warning about shooting the bodyguard
                        if (bodyguardPlayer && !roleSection.querySelector('.bodyguard-warning')) {
                            const warningElement = document.createElement('div');
                            warningElement.className = 'action-result warning bodyguard-warning';
                            warningElement.innerHTML = `<p><strong>Warning:</strong> If you target the Bodyguard, YOU will be eliminated instead!</p>`;
                            roleSection.insertBefore(warningElement, roleSection.querySelector('.players-grid'));
                        }
                    }
                    
                    if (!roleExists) {
                        // If role was never in the game, hide the section
                        roleSection.style.display = 'none';
                    } else if (!roleAlive) {
                        // If role is dead, show section but display inactive status
                        roleSection.classList.add('inactive-role');
                        
                        // Check if warning already added
                        if (!roleSection.querySelector('.action-result.warning')) {
                            const statusElement = document.createElement('div');
                            statusElement.className = 'action-result warning';
                            statusElement.innerHTML = `<p>${capitalizeFirstLetter(role.id)} is no longer alive. This action cannot be performed but will be shown for consistency.</p>`;
                            roleSection.appendChild(statusElement);
                        }
                    }
                }
            });
            
            // Add bullet count to the Professional section title if professional exists and is alive
            const professionalExists = allPlayers.some(p => p.role === 'professional');
            const professionalAlive = alivePlayers.some(p => p.role === 'professional');
            
            if (professionalExists && professionalAlive && gameState.professionalBullets > 0) {
                const professionalSection = document.getElementById('professional-call');
                if (professionalSection) {
                    const heading = professionalSection.querySelector('h3');
                    if (heading) {
                        heading.textContent = `4. Professional Wake Up (${gameState.professionalBullets} bullet${gameState.professionalBullets !== 1 ? 's' : ''} left)`;
                    }
                    
                    // Remove pass button code - not selecting a target will implicitly save the bullet
                }
            }
        }

        // Check if Zodiac should act tonight
        function shouldZodiacActTonight() {
            // Zodiac acts on Night 1 and then every other night
            // Night 0: Initial setup (counter 0)
            // Night 1: First night (counter 1) - Zodiac acts
            // Night 2: Second night (counter 2) - Zodiac doesn't act
            // Night 3: Third night (counter 3) - Zodiac acts
            // Night 4: Fourth night (counter 4) - Zodiac doesn't act
            // etc.
            
            if (!gameState.zodiacNightCounter) {
                gameState.zodiacNightCounter = 0;
            }
            
            // Check if night counter is odd (1, 3, 5, etc.)
            return gameState.zodiacNightCounter > 0 && gameState.zodiacNightCounter % 2 === 1;
        }
        
        // Disable doctor's ability to select themselves
        function disableDoctorSelfSelection() {
            const doctorPlayer = getAlivePlayers().find(p => p.role === 'doctor');
            if (!doctorPlayer) return;
            
            const doctorId = doctorPlayer.id;
            const doctorCard = document.querySelector(`[data-player-id="${doctorId}"][data-role="doctor-target"]`);
            
            if (doctorCard) {
                doctorCard.classList.add('disabled');
                doctorCard.style.opacity = '0.5';
                doctorCard.style.pointerEvents = 'none';
                
                // Add an indicator that self-selection is disabled
                if (!doctorCard.querySelector('.no-self-save')) {
                    const selfSaveIndicator = document.createElement('div');
                    selfSaveIndicator.className = 'no-self-save';
                    selfSaveIndicator.style.position = 'absolute';
                    selfSaveIndicator.style.top = '5px';
                    selfSaveIndicator.style.right = '5px';
                    selfSaveIndicator.style.background = 'rgba(244, 67, 54, 0.8)';
                    selfSaveIndicator.style.color = 'white';
                    selfSaveIndicator.style.borderRadius = '50%';
                    selfSaveIndicator.style.width = '25px';
                    selfSaveIndicator.style.height = '25px';
                    selfSaveIndicator.style.display = 'flex';
                    selfSaveIndicator.style.alignItems = 'center';
                    selfSaveIndicator.style.justifyContent = 'center';
                    selfSaveIndicator.innerHTML = 'âœ—';
                    
                    doctorCard.appendChild(selfSaveIndicator);
                }
            }
        }

        // Display night role players for a specific role
        function displayPlayers(roleId, containerId, excludePlayerIds = []) {
            console.log(`Displaying players for ${roleId} in container ${containerId}`);
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container with ID ${containerId} not found`);
                return;
            }
            
            const alivePlayers = getAlivePlayers();
            if (!alivePlayers || alivePlayers.length === 0) {
                console.error("No alive players found");
                return;
            }
            
            // Get the player who has the active role
            const activeRolePlayer = alivePlayers.find(p => p.role === roleId);
            
            // Special handling for Mafia roles due to inheritance
            let activeGodfather = null;
            if (['godfather', 'magician', 'bomber'].includes(roleId)) {
                activeGodfather = getActiveGodfather();
            }
            
            // For Ocean, we need special handling for teammates
            const isSelectingSecondTeammate = roleId === 'ocean' && 
                                             nightState.actions.ocean.teammates && 
                                             nightState.actions.ocean.teammates.length > 0;
            
            let playersHtml = '';
            
            // Create player cards
            alivePlayers.forEach(player => {
                // Skip excluded players
                if (excludePlayerIds && excludePlayerIds.includes(player.id)) {
                    return;
                }
                
                // Determine if this player holds the current role
                let isRoleHolder = false;
                
                // Special case for Mafia roles with inheritance
                if (['godfather', 'magician', 'bomber'].includes(roleId)) {
                    // For Godfather section, highlight the active godfather (which might be inherited)
                    if (roleId === 'godfather' && activeGodfather && player.id === activeGodfather.id) {
                        isRoleHolder = true;
                    } 
                    // For other Mafia roles, highlight the player with that specific role
                    else if (roleId !== 'godfather' && player.role === roleId) {
                        isRoleHolder = true;
                    }
                } 
                // For other roles, simple match
                else if (player.role === roleId) {
                    isRoleHolder = true;
                }
                
                // Determine if this player is a team member (for Mafia)
                const isTeamMember = ['godfather', 'magician', 'bomber'].includes(roleId) && 
                                    ['godfather', 'magician', 'bomber', 'regular_mafia'].includes(player.role) &&
                                    !isRoleHolder; // Only mark as team member if not the role holder
                
                // Check if this player is currently selected for this role
                const isSelected = isPlayerSelected(roleId, player.id);
                
                // Determine if player should be disabled (cannot be selected)
                let isDisabled = false;
                
                // Role-specific disable logic
                if (roleId === 'ocean' && player.role === 'ocean') {
                    // Ocean can't select themselves
                    isDisabled = true;
                } 
                else if (roleId === 'doctor' && player.role === 'doctor' && 
                        gameState.doctorSelfSavesRemaining !== undefined && 
                        gameState.doctorSelfSavesRemaining <= 0) {
                    // Doctor can't save themselves if out of self-saves
                    isDisabled = true;
                } 
                else if (roleId === 'magician' && 
                       ['godfather', 'magician', 'bomber', 'regular_mafia'].includes(player.role)) {
                    // Magician can't block other Mafia members
                    isDisabled = true;
                }
                else if (roleId === 'gunman' && player.role === 'gunman') {
                    // Gunman can't give the gun to themselves
                    isDisabled = true;
                }
                
                // Apply CSS classes based on player state
                let cardClasses = ['player-card'];
                let imageClasses = ['player-image'];
                
                if (isRoleHolder) cardClasses.push('active-player');
                if (isTeamMember) cardClasses.push('team-player');
                if (isSelected) cardClasses.push('selected');
                
                // Only add disabled class to the image, not the whole card
                if (isDisabled) imageClasses.push('disabled');
                
                // Get player image
                const defaultImage = 'images/default-avatar.svg';
                const imageUrl = player.photo_url || defaultImage;
                
                // Create the player card HTML
                playersHtml += `
                    <div class="${cardClasses.join(' ')}" data-player-id="${player.id}">
                        <div class="${imageClasses.join(' ')}" onclick="selectPlayer('${roleId}', '${player.id}')">
                            <img src="${imageUrl}" 
                                 alt="${player.name}" 
                                 onerror="this.onerror=null; this.src='${defaultImage}';">
                        </div>
                        <div class="player-info">
                            <h4>${player.name}</h4>
                            ${player.sequence !== undefined ? `<small>#${player.sequence}</small>` : ''}
                            ${isRoleHolder ? `<small>(${capitalizeFirstLetter(player.role)})</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = playersHtml;
            
            // If no players were displayed, add a message
            if (playersHtml === '') {
                container.innerHTML = '<p class="text-center">No eligible players to display</p>';
            }
            
            console.log(`Displayed ${alivePlayers.length} players for ${roleId}`);
        }

        // Show next role in sequence after Ocean
        function goFromOceanToZodiac() {
            completeRoleAction('ocean');
            showNextRole('zodiac');
        }

        // Function to update Ocean teammates display
        function updateOceanTeammatesDisplay() {
            const teammatesInfo = document.getElementById('ocean-teammates-info');
            const teammatesList = document.getElementById('ocean-teammates-list');
            
            if (teammatesInfo && teammatesList) {
                if (nightState.actions.ocean.teammates.length > 0) {
                    const teammateNames = nightState.actions.ocean.teammates.map(id => {
                        const player = gameState.players.find(p => p.id === id);
                        return player ? player.name : 'Unknown';
                    }).join(', ');
                    
                    teammatesList.textContent = teammateNames;
                    teammatesInfo.style.display = 'block';
                } else {
                    teammatesList.textContent = 'None selected yet';
                    teammatesInfo.style.display = 'none';
                }
            }
        }

        // Function to start Ocean chat timer
        function startOceanChat() {
            // Show the timer
            document.getElementById('ocean-chat-options').style.display = 'none';
            document.getElementById('ocean-chat-timer').style.display = 'block';
            document.getElementById('ocean-action-btn').style.display = 'none';
            
            // Reset and start the timer
            oceanSecondsRemaining = 30;
            
            // Update display
            document.getElementById('ocean-timer-display').textContent = oceanSecondsRemaining;
            
            // Set interval for countdown
            oceanTimerInterval = setInterval(() => {
                oceanSecondsRemaining--;
                
                // Update display
                const timerDisplay = document.getElementById('ocean-timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = oceanSecondsRemaining;
                }
                
                // End chat when timer reaches zero
                if (oceanSecondsRemaining <= 0) {
                    clearInterval(oceanTimerInterval);
                    endOceanChat();
                }
            }, 1000);
        }
        
        // Function to end Ocean chat
        function endOceanChat() {
            // Mark chat as completed
            nightState.actions.ocean.chatCompleted = true;
            
            // Hide timer
            document.getElementById('ocean-chat-timer').style.display = 'none';
            
            // Move to next role automatically
            skipCurrentRole();
        }
        
        // Document ready function to set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Ocean action button
            const oceanActionBtn = document.getElementById('ocean-action-btn');
            if (oceanActionBtn) {
                oceanActionBtn.addEventListener('click', function() {
                    startOceanChat();
                });
            }
            
            // Add event listener for ending ocean chat early
            const endOceanChatBtn = document.getElementById('end-ocean-chat-btn');
            if (endOceanChatBtn) {
                endOceanChatBtn.addEventListener('click', function() {
                    if (oceanTimerInterval) {
                        clearInterval(oceanTimerInterval);
                        endOceanChat();
                    }
                });
            }
            
            // Select second teammate button
            const selectSecondTeammateBtn = document.getElementById('select-second-teammate-btn');
            if (selectSecondTeammateBtn) {
                selectSecondTeammateBtn.addEventListener('click', function() {
                    document.getElementById('ocean-select-option').style.display = 'none';
                    document.getElementById('ocean-select-players').style.display = 'block';
                    document.getElementById('ocean-status').textContent = 'Choose your second teammate:';
                    
                    // Display players but exclude already selected teammate
                    displayPlayers('ocean', 'ocean-players', nightState.actions.ocean.teammates);
                });
            }
            
            // Skip second teammate button
            const skipSecondTeammateBtn = document.getElementById('skip-second-teammate-btn');
            if (skipSecondTeammateBtn) {
                skipSecondTeammateBtn.addEventListener('click', function() {
                    document.getElementById('ocean-select-option').style.display = 'none';
                    document.getElementById('ocean-chat-options').style.display = 'block';
                    document.getElementById('ocean-action-btn').style.display = 'block';
                    document.getElementById('ocean-status').textContent = 'Ready for private chat with your teammate.';
                });
            }
        });
        
        // Check if a player is protected by the doctor
        function isPlayerProtectedByDoctor(playerId) {
            return nightState.actions.doctor.target === playerId && !isRoleBlocked('doctor');
        }

        // Check if Professional has bullets left
        function hasProfessionalBullets() {
            return (gameState.professionalBullets || 0) > 0;
        }

        // Check if this is an active night for Zodiac (every third night)
        function isZodiacActiveNight() {
            // Zodiac can act on nights 3, 6, 9, etc. (every third night)
            // Adjust counter for 0-based indexing
            const nightCounter = (gameState.zodiacNightCounter || 0);
            return (nightCounter % 3) === 0; // Nights 0, 3, 6, 9, etc.
        }

        // Check if a player is selected for a specific role
        function isPlayerSelected(roleId, playerId) {
            // Check in the nightState.actions object based on the role
            switch (roleId) {
                case 'godfather':
                    return nightState.actions.mafia.godfather.target === playerId;
                case 'magician':
                    return nightState.actions.mafia.magician.target === playerId;
                case 'bomber':
                    return nightState.actions.mafia.bomber.target === playerId;
                case 'detective':
                    return nightState.actions.detective.target === playerId;
                case 'doctor':
                    return nightState.actions.doctor.target === playerId;
                case 'professional':
                    return nightState.actions.professional.target === playerId;
                case 'gunman':
                    return nightState.actions.gunman.target === playerId;
                case 'ocean':
                    return nightState.actions.ocean.target === playerId;
                case 'zodiac':
                    return nightState.actions.zodiac.target === playerId;
                default:
                    return false;
            }
        }

        // Ocean role function for player selection
        function handleOceanSelection(playerId) {
            // Check if player is already a teammate
            if (nightState.actions.ocean.teammates.includes(playerId)) {
                console.log('Player is already a teammate');
                return;
            }
            
            // Check if player is Mafia or Zodiac
            const targetPlayer = gameState.players.find(p => p.id === playerId);
            const isMafiaOrZodiac = targetPlayer && (
                ['godfather', 'magician', 'bomber', 'regular_mafia', 'zodiac'].includes(targetPlayer.role)
            );
            
            // Check if this is the first or second selection
            const isFirstSelection = nightState.actions.ocean.teammates.length === 0;
            
            // Add player to teammates array
            if (isFirstSelection) {
                // This is the first teammate
                nightState.actions.ocean.teammates = [playerId];
                nightState.actions.ocean.target = playerId; // Set target for compatibility
            } else {
                // This is the second teammate - keep the first one and add the second
                const firstTeammate = nightState.actions.ocean.teammates[0];
                nightState.actions.ocean.teammates = [firstTeammate, playerId];
                nightState.actions.ocean.secondTeammateSelected = true;
            }
            
            // Store in global game state for persistence
            gameState.oceanTeammates = nightState.actions.ocean.teammates;
            
            // Update the display of selected teammates
            updateOceanTeammatesDisplay();
            
            // If Ocean selected Mafia or Zodiac player, mark for elimination
            if (isMafiaOrZodiac) {
                // Mark the Ocean player for elimination in the next morning
                const oceanPlayer = gameState.players.find(p => p.role === 'ocean');
                if (oceanPlayer) {
                    nightState.results.deaths.push({
                        id: oceanPlayer.id,
                        name: oceanPlayer.name,
                        role: 'ocean',
                        reason: `Selected a Mafia or Zodiac player as teammate`,
                        saved: false
                    });
                }
            }
            
            // Hide the selection view and show the chat options
            document.getElementById('ocean-select-players').style.display = 'none';
            document.getElementById('ocean-chat-options').style.display = 'block';
            
            // Update the action button to reflect the current state
            document.getElementById('ocean-action-btn').textContent = 'Start 30-Second Chat';
            document.getElementById('ocean-action-btn').style.display = 'block';
        }

        // Show Ocean section and prepare UI
        function showOceanSection() {
            // Reset Ocean action state
            nightState.actions.ocean.chatCompleted = false;
            
            // Use teammates from game state if they exist
            if (!nightState.actions.ocean.teammates) {
                nightState.actions.ocean.teammates = gameState.oceanTeammates || [];
            }
            
            // Set up player selection for Ocean
            displayPlayers('ocean', 'ocean-players');
            
            // Update UI based on current state
            updateOceanTeammatesDisplay();
            
            // Check if Ocean exists and is alive
            const oceanExists = gameState.players.some(p => p.role === 'ocean');
            const oceanAlive = getAlivePlayers().some(p => p.role === 'ocean');
            
            if (!oceanExists || !oceanAlive) {
                // Ocean doesn't exist or is dead
                skipRoleBasedOnId('ocean');
                return;
            }
            
            // Show the selection or chat options based on the current state
            const selectPlayersElement = document.getElementById('ocean-select-players');
            const chatOptionsElement = document.getElementById('ocean-chat-options');
            const selectOptionElement = document.getElementById('ocean-select-option');
            
            // Make sure required elements exist
            if (!selectPlayersElement || !chatOptionsElement || !selectOptionElement) {
                console.error('Missing required Ocean elements');
                return;
            }
            
            if (nightState.actions.ocean.teammates.length === 0) {
                // No teammates selected yet, show selection
                document.getElementById('ocean-status').textContent = 'Choose a player for a private chat:';
                selectPlayersElement.style.display = 'block';
                chatOptionsElement.style.display = 'none';
                selectOptionElement.style.display = 'none';
                
                // Hide action button until selection is made
                const actionBtn = document.getElementById('ocean-action-btn');
                if (actionBtn) actionBtn.style.display = 'none';
                
            } else if (nightState.actions.ocean.teammates.length === 1 && gameState.currentRound > 1) {
                // First teammate selected, and it's not the first night, offer to select second
                document.getElementById('ocean-status').textContent = 'You already have one teammate selected.';
                selectOptionElement.style.display = 'block';
                selectPlayersElement.style.display = 'none';
                chatOptionsElement.style.display = 'none';
                
                // Hide action button during selection
                const actionBtn = document.getElementById('ocean-action-btn');
                if (actionBtn) actionBtn.style.display = 'none';
                
            } else {
                // Teammate(s) already selected, show chat option
                document.getElementById('ocean-status').textContent = 'Ready for private chat with your teammate(s).';
                selectPlayersElement.style.display = 'none';
                selectOptionElement.style.display = 'none';
                chatOptionsElement.style.display = 'block';
                
                // Show action button
                const actionBtn = document.getElementById('ocean-action-btn');
                if (actionBtn) {
                    actionBtn.textContent = 'Start 30-Second Chat';
                    actionBtn.style.display = 'block';
                }
            }
            
            // Show the Ocean section
            document.getElementById('ocean-call').style.display = 'block';
        }

        // Get the active godfather based on inheritance rules
        function getActiveGodfather() {
            const alivePlayers = getAlivePlayers();
            
            // Check if Godfather is alive
            const godfather = alivePlayers.find(p => p.role === 'godfather');
            if (godfather) return godfather;
            
            // If Godfather is dead, check if Magician is alive
            const magician = alivePlayers.find(p => p.role === 'magician');
            if (magician) return magician;
            
            // If both are dead, check if Bomber is alive
            const bomber = alivePlayers.find(p => p.role === 'bomber');
            if (bomber) return bomber;
            
            // If all special Mafia are dead, check for regular Mafia
            const regularMafia = alivePlayers.find(p => p.role === 'regular_mafia');
            if (regularMafia) return regularMafia;
            
            // No Mafia left
            return null;
        }
    </script>
</body>
</html> 
